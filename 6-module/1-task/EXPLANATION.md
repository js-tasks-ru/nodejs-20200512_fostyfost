# MongoDB / Mongoose

# Базы данных нужны для эффективной и надежной работы с данными в приложении: для создания, изменения, 
удаления и поиска информации.

## MongoDB

Мы будем использовать базу данных MongoDB, потому что она позволяет гораздо быстрее начать разрабатывать приложение, 
однако основные принципы одинаковы для любых других баз данных.

Установка базы данных MongoDB очень проста и может быть выполнена на любой операционной системе, 
подробная инструкция доступна на 
[официальном сайте](https://docs.mongodb.com/manual/administration/install-community/). 
Все команды к базе данных можно выполнять прямо в командной строке, 
но когда данных становится много может быть удобнее использовать графический интерфейс, 
например [Robo 3T](https://robomongo.org/) или [MongoDB Compass](https://www.mongodb.com/products/compass).

Основные сущности в базе данных MongoDB – это коллекции и документы. Например, коллекция `users` 
хранит в себе множество документов `user`. С помощью запросов на языке Javascript мы можем 
создавать новых пользователей – `db.users.insertOne({name: 'Ivan', age: 20})`, 
изменять текущих - `db.users.updateOne({name: 'Ivan'}, {$set: {age: 21}})`, 
искать пользователей по некоторому условию среди всех документов в коллекции – `db.users.find({age: {$gt: 18}})`, 
а также выполнять множество других операций. 
Любые операции можно выполнять на базе данных без необходимости заранее создавать коллекции 
или документы – так, если попытаться создать документ в коллекцию, которой еще нет, 
MongoDB создаст ее и добавит в нее новый документ.

## Mongoose

Для того, чтобы работать с базой данных из Node.JS мы будем использовать библиотеку `mongoose`. 
Она позволяет нам объявлять логику валидации, преобразования документов в модели и многие другие полезные операции.

### Подключение к базе данных

Для подключения к базе данных необходимо вызвать метод `mongoose.connect()`. 
В качестве аргументов этот метод принимает адрес сервера базы данных, а также конкретное название базы данных. 
По умолчанию используется локальная база данных `test` (`mongodb://localhost/test`).

### Схема данных

Использование библиотеки `mongoose` начинается с определения схемы данных нашей будущей модели, 
с описания полей и их типов, валидаций и прочего. 
Описание всех возможных опций находится на [официальном сайте](https://mongoosejs.com/docs/guide.html).

На этапе объявления схемы мы можем также определить какие индексы будут созданы для данной коллекции. 
Индексы – это специальные представления коллекций, которые позволяет ускорить и сделать эффективным 
поиск по заранее известным критериям. Например, если мы понимаем, что будем в дальнейшем в ходе работы часто 
производить поиск по адресу пользователя имеет смысл создать индекс по полям `city`, `street`, `house_number`. 
Кроме этого, если требования подразумевают, что какое-то значение должно быть уникальным – это тоже 
подразумевает создание индекса, например, поле `email` с большой долей вероятности должно быть уникальным.

### Создание модели

На основании схемы мы можем создать модель. Модель – это сущность, которая позволяет нам выполнять операции создания, поиска, изменения и удаления данных в базе.

### Запросы

Все асинхронные операции `mongoose` возвращают промисы. Примеры запросов к базе данных:

```js

// Поиск всех пользователей:
await User.find({});

// Поиск 1 пользователя с заданным email:
await User.findOne({email: 'email@mail.com'});

// Создание нового пользователя:
await User.create({email: 'email@mail.com', name: 'user'});

```

### Связанные документы

`Mongoose` позволяет «связывать» документы, находящиеся как в одной и той же коллекции 
(например, друзья пользователя являются другими пользователями), так и в разных – товары в корзине у пользователя 
могут находиться в коллекции `goods`. Реализуется это с помощью указания хранимому полю типа `ObjectId`, 
а также названия модели соответствующей сущности `ref`. Замена таких полей полноценными документами из базы данных 
выполняется с помощью метода `.populate()`. Более подробно об этом можно почитать 
в [официальной документации](https://mongoosejs.com/docs/populate.html). 
Пример объявления модели `User`, у которой поле `friends` будет содержать список идентификаторов других 
пользователей – друзей данного:

```js

const schema = new mongoose.Schema({
  email: {
    type: String,
    required: 'E-mail пользователя не должен быть пустым.',
    validate: [
      {
        validator(value) {
          return /^[-.\w]+@([\w-]+\.)+[\w-]{2,12}$/.test(value);
        },
        message: 'Некорректный email.',
      },
    ],
    unique: 'Такой email уже существует',
  },
  displayName: {
    type: String,
    required: 'У пользователя должно быть имя',
    unique: 'Такое имя уже существует',
  },
  friends: [{
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User'
  }]
});

```

## Модели товара и категории

Любая модель `mongoose` должна содержать схему данных, так что наша первая задача состоит в том, 
чтобы объявить схему данных наших будущих моделей категории и товара.

Схема создается инстанцированием класса `mongoose.Schema` с передачей конфигурации полей в качестве первого 
аргумента и дополнительными настройками – вторым.

Так будет выглядеть схема для категорий товаров:

```js

const schema = new mongoose.Schema({/*
  fieldName: { ...fieldProperties... }
*/}, {/*
  ...settings...
*/});

```

Приступим к объявлению полей модели категории:

```js

const subCategorySchema = new mongoose.Schema({
  title: {
    type: String,
    required: true,
  }
});

const categorySchema = new mongoose.Schema({
  title: {
    type: String,
    required: true,
  },

  subcategories: [subCategorySchema]
});

```

Обратите внимание, в данном случае мы объявили подкатегории как отдельную схему, 
это позволит нам использовать их идентификаторы в дальнейшем при создании и поиске товаров.

Теперь, когда схема готова – можно создать модель с помощью метода `mongoose.model`. 
В качестве аргументов в нее передаются:

* название модели
* схема данных
* название коллекции (опционально)

Обратите внимание, название коллекции можно не передавать – в этом случае `mongoose` будет использовать 
множественное число, образованное от названия модели (`Category` → `categories`).

Аналогичным образом создаётся и схема для товаров:

```js

const productSchema = new mongoose.Schema({
  title: {
    type: String,
    required: true,
  },

  description: {
    type: String,
    required: true,
  },

  price: {
    type: Number,
    required: true,
  },

  category: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Category',
    required: true,
  },

  subcategory: {
    type: mongoose.Schema.Types.ObjectId,
    required: true,
  },

  images: [String],

});

```

Так как мы не планируем в будущем специальным образом обращаться к изображениям товара, 
то и объявить их можно просто как массив строк (в дальнейшем там будут храниться ссылки на изображения товаров).
